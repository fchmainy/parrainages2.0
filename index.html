<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parrainage 2.0</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #ffffff;
      color: #002f6c;
    }
    header {
      background: white;
      color: #002f6c;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header img {
      height: 40px;
    }
    main {
      padding: 2em;
      max-width: 700px;
      margin: auto;
    }
    .highlight {
      color: #ffd700;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.75em;
      margin: 0.5em 0;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    button {
      background-color: #002f6c;
      color: white;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    label {
      display: block;
      margin: 0.3em 0;
    }
    #district-select {
      width: auto;
      position: absolute;
      top: 1em;
      right: 1em;
    }
    .checkbox-inline label {
      display: inline-block;
      margin-right: 1em;
    }
  </style>
  <script>
    const districts = [
      { name: 'Paris', lat: 48.8566, lon: 2.3522, email: 'paris@club.org' },
      { name: 'Lyon', lat: 45.75, lon: 4.85, email: 'lyon@club.org' },
      { name: 'Marseille', lat: 43.2965, lon: 5.3698, email: 'marseille@club.org' },
      { name: 'Lille', lat: 50.6292, lon: 3.0573, email: 'lille@club.org' },
      { name: 'Toulouse', lat: 43.6047, lon: 1.4442, email: 'toulouse@club.org' }
    ];

    let selectedDistrict = null;

    async function setRegionTitle() {
      const initGeo = async () => {
        try {
          const res = await fetch('https://ipapi.co/json/');
          const data = await res.json();
          const userLat = data.latitude;
          const userLon = data.longitude;

          let minDistance = Infinity;
          for (const district of districts) {
            const distance = Math.sqrt(
              Math.pow(userLat - district.lat, 2) +
              Math.pow(userLon - district.lon, 2)
            );
            if (distance < minDistance) {
              minDistance = distance;
              selectedDistrict = district;
            }
          }

          if (selectedDistrict) {
            document.getElementById('region-title').innerText = `Bienvenue à proximité de ${selectedDistrict.name}`;
            document.getElementById('district-select').value = selectedDistrict.name;
          }
        } catch (e) {
          document.getElementById('region-title').innerText = 'Bienvenue';
        }
      };

      document.addEventListener('click', initGeo, { once: true });
      document.addEventListener('scroll', initGeo, { once: true });
    }

    function updateManualDistrict(name) {
      const district = districts.find(d => d.name === name);
      if (district) {
        selectedDistrict = district;
        document.getElementById('region-title').innerText = `Bienvenue à proximité de ${district.name}`;
      }
    }

    function goToFormPage() {
      const emailInput = document.getElementById('email').value.trim();
      if (!emailInput || !emailInput.includes('@')) {
        alert('Veuillez entrer une adresse email valide.');
        return;
      }
      document.getElementById('page1').classList.add('hidden');
      document.getElementById('page2').classList.remove('hidden');
    }

    function validateForm() {
      const requiredFields = document.querySelectorAll('#page2 input[required], #page2 textarea[required]');
      for (const field of requiredFields) {
        if (!field.value.trim()) {
          alert('Veuillez remplir tous les champs obligatoires.');
          field.focus();
          return false;
        }
      }
      sendForm();
    }

    async function sendForm() {
      const formData = new FormData(document.getElementById('formulaire'));
      const data = Object.fromEntries(formData.entries());
      data.email_utilisateur = document.getElementById('email').value.trim();
      data.district = selectedDistrict?.name || 'Inconnu';
      data.toEmail = selectedDistrict?.email || 'admin@club.org';
      await fetch('https://webhook.site/b1330eed-2f86-4f99-bdef-64902779fa76', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      alert('Candidature envoyée !');
    }

    window.onload = () => {
      setRegionTitle();
    }
  </script>
</head>
<body>
  <header>
    <img src="https://www.rotary.org/sites/all/themes/rotary_rotaryorg/images/rotary-logo-color-2019-simplified.svg" alt="Logo" id="logo">
    <h1 id="region-title">Bienvenue</h1>
    <select id="district-select" onchange="updateManualDistrict(this.value)">
      <option value="">-- Choisissez votre ville --</option>
      <option value="Paris">Paris</option>
      <option value="Lyon">Lyon</option>
      <option value="Marseille">Marseille</option>
      <option value="Lille">Lille</option>
      <option value="Toulouse">Toulouse</option>
    </select>
  </header>

  <main>
    <div id="page1">
      <h2>Entrez votre adresse email pour commencer</h2>
      <input type="email" id="email" placeholder="Votre adresse email" required>
      <button onclick="goToFormPage()">Continuer</button>
    </div>

    <div id="page2" class="hidden">
      <form id="formulaire" onsubmit="event.preventDefault(); validateForm();">
        <h2>Je propose la candidature de</h2>
        <select name="titre" required>
          <option value="">Titre</option>
          <option>M.</option>
          <option>Mme</option>
          <option>Autre</option>
        </select>
        <input name="prenom" placeholder="Prénom" required>
        <input name="nom" placeholder="Nom" required>
        <input name="adresse" placeholder="Adresse" required>
        <input name="code_postal" placeholder="Code Postal" required>
        <input name="pays" placeholder="Pays" required>
        <input name="email_candidat" type="email" placeholder="Email" required>
        <input name="telephone" placeholder="Téléphone portable" required>
        <input name="metier" placeholder="Métier / Classification" required>

        <div class="checkbox-inline">
          <label><input type="checkbox" name="statut" value="actif"> En Activité</label>
          <label><input type="checkbox" name="statut" value="retraite"> Retraité</label>
        </div>

        <h3>Informations supplémentaires</h3>
        <input name="club_precedent" placeholder="Club précédent">
        <input name="date_debut" placeholder="De (date départ)">
        <input name="date_fin" placeholder="À (date fin)">
        <input name="id_precedent" placeholder="Numéro d’identification précédent">
        <label><input type="checkbox" name="transfert_recent"> Transfert Récent (moins d’un an)</label>

        <div class="checkbox-inline">
          <label><input type="checkbox" name="cat[]" value="inter"> Inter</label>
          <label><input type="checkbox" name="cat[]" value="act"> Act</label>
          <label><input type="checkbox" name="cat[]" value="ry"> Ry</label>
          <label><input type="checkbox" name="cat[]" value="lo"> Lo</label>
          <label><input type="checkbox" name="cat[]" value="echange"> Echange</label>
          <label><input type="checkbox" name="cat[]" value="autre"> Autre</label>
        </div>

        <textarea name="motivations" placeholder="Description de vos motivations" required></textarea>
        <textarea name="programme_ancien" placeholder="Ancien du programme Club ou Fondation ? Précisez le programme et la période"></textarea>

        <button type="submit">Soumettre la candidature</button>
      </form>
    </div>
  </main>
</body>
</html>
